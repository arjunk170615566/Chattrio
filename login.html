<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>chatting</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* Fonts + Root variables */
    :root {
      --wa-header-bg: #005c97;
      --wa-accent-blue: #34B7F1;
      --wa-message-out-bg: #e1f6fb;
      --wa-message-in-bg: #ffffff;
      --wa-app-bg: #f0f2f5;
      --wa-chat-bg: #e5ddd5;
      --wa-icon-color: #f0f2f5;
      --wa-text-primary: #111b21;
      --wa-text-secondary: #667781;
      --wa-border-color: #e9edef;
      --wa-active-tab-indicator: var(--wa-accent-blue);
      --wa-button-color: #008069;
      --wa-link-color: #00a8e8;
      --wa-shadow: rgba(17, 27, 33, 0.15);
      --max-width: 450px;
      --max-height: 950px;
      --app-bg-page: #d1d7db;
    }

    * { box-sizing: border-box; }
    html,body { height:100%; width:100%; margin:0; padding:0; font-family: 'Roboto', sans-serif; background: var(--app-bg-page); overflow: hidden; display:flex; align-items:center; justify-content:center; }

    /* custom scrollbar */
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius:10px; }

    /* app container */
    #app-container {
      width:100%;
      max-width: var(--max-width);
      max-height: var(--max-height);
      height:92vh;
      background: var(--wa-app-bg);
      box-shadow: 0 8px 30px var(--wa-shadow);
      border-radius: 12px;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      position: relative;
    }

    .view { display:none; flex-direction: column; height:100%; width:100%; }
    .view.active { display:flex; }

    /* Auth View */
    #auth-view { align-items:center; justify-content:center; padding:24px; gap:18px; }
    #auth-view h1 { margin:0; font-size:28px; color:var(--wa-text-primary); font-weight:700; }
    .auth-forms { width:100%; max-width:360px; background:#fff; border-radius:10px; padding:18px; box-shadow: 0 4px 14px var(--wa-shadow); border:1px solid var(--wa-border-color); }
    .auth-forms form { display:flex; flex-direction:column; gap:10px; }
    .auth-forms input[type="email"], .auth-forms input[type="password"], .auth-forms input[type="text"] {
      padding:12px 14px; border-radius:8px; border:1px solid var(--wa-border-color); outline:none; font-size:14px;
    }
    .auth-forms input:focus { border-color:var(--wa-accent-blue); box-shadow: 0 0 0 3px rgba(52,183,241,0.12); }
    .auth-forms button { padding:10px 12px; background:var(--wa-button-color); color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
    .link-like { color:var(--wa-link-color); text-decoration:underline; cursor:pointer; font-size:14px; display:inline-block; margin-top:6px; }
    .hidden { display:none !important; }
    .error { color:#b00020; font-size:13px; margin-top:6px; }

    /* Main App Header */
    .main-header { background: linear-gradient(180deg, var(--wa-header-bg), #004970); color:var(--wa-icon-color); padding:12px 14px; display:flex; flex-direction:column; gap:8px; }
    .header-top { display:flex; align-items:center; justify-content:space-between; }
    .title { font-weight:700; font-size:18px; display:flex; align-items:center; gap:8px; }
    .icon-group { display:flex; gap:8px; }
    .icon-btn {
      width:40px; height:40px; border-radius:10px; border:0; display:inline-flex; align-items:center; justify-content:center; background:transparent; color:var(--wa-icon-color); cursor:pointer;
    }
    .icon-btn svg { width:20px; height:20px; fill:currentColor; }

    .header-nav { display:flex; gap:8px; align-items:center; padding:6px; background: rgba(255,255,255,0.03); border-radius:8px; }
    .nav-tab { flex:1; text-align:center; padding:8px 10px; cursor:pointer; color:var(--wa-icon-color); position:relative; font-weight:500; }
    .nav-tab.active { border-bottom:3px solid var(--wa-active-tab-indicator); color:#fff; }
    .nav-tab .badge { position:absolute; top:4px; right:14px; min-width:18px; height:18px; font-size:11px; background:#ff3b30; color:#fff; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; padding:0 6px; }

    #main-content { flex:1; display:flex; flex-direction:column; overflow:auto; padding:12px; gap:12px; }

    .content-panel { display:none; }
    .content-panel.active { display:block; }

    /* List items */
    .list-item { display:flex; align-items:center; gap:12px; padding:10px; background:#fff; border-radius:10px; border:1px solid var(--wa-border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
    .list-item .avatar { width:48px; height:48px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; background:var(--wa-accent-blue); color:#fff; }
    .list-item .details { flex:1; display:flex; flex-direction:column; }
    .list-item .meta { font-size:13px; color:var(--wa-text-secondary); margin-top:4px; }

    /* Chat view */
    #chat-view { position:relative; background:#fff; }
    .chat-header { display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid var(--wa-border-color); background:#fff; }
    .chat-header .back-btn { background:transparent; border:0; cursor:pointer; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; }
    .chat-header .contact-title { font-weight:700; font-size:16px; }
    #chat-messages { flex:1; height:calc(100% - 180px); overflow:auto; padding:18px; background: var(--wa-chat-bg) url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23bdbdbd' fill-opacity='0.15' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E"); display:flex; flex-direction:column; gap:10px; }
    .message-bubble { max-width:70%; padding:10px 12px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.04); font-size:14px; line-height:1.3; }
    .message-sent { align-self:flex-end; background:var(--wa-message-out-bg); border-bottom-right-radius:4px; }
    .message-received { align-self:flex-start; background:var(--wa-message-in-bg); border-bottom-left-radius:4px; }

    #chat-input-container { display:flex; gap:8px; padding:12px; border-top:1px solid var(--wa-border-color); background:#fff; }
    #chat-input { flex:1; padding:12px 14px; border-radius:24px; border:1px solid var(--wa-border-color); outline:none; }
    #chat-send-btn { padding:10px 14px; border-radius:12px; border:0; background:var(--wa-accent-blue); color:#fff; cursor:pointer; }

    /* Call views (overlay) */
    .call-view { position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:40; }
    .call-view.active { display:flex; }
    #remote-video { width:100%; height:100%; object-fit:cover; background:#000; }
    #local-video { width:140px; height:100px; position:absolute; right:16px; top:16px; border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); overflow:hidden; transform:translateY(0); cursor:grab; }
    .call-overlay { position:absolute; bottom:18px; left:18px; right:18px; display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:12px; background: linear-gradient(90deg, rgba(0,0,0,0.6), rgba(0,0,0,0.25)); color:#fff; }
    .caller-info { display:flex; flex-direction:column; gap:4px; }
    .call-controls { display:flex; gap:8px; }
    .call-btn { padding:10px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:600; color:#fff; }
    .call-end { background:#e91e63; }
    .call-accept { background:#4CAF50; }

    /* Modals */
    .modal { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:60; }
    .modal.active { display:flex; }
    .modal-content { width:100%; max-width:420px; background:#fff; border-radius:12px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
    .modal-content h3 { margin:0 0 12px 0; }
    .modal-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .small-btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; }

    /* responsive-ish */
    @media (max-width:420px) {
      #app-container { height:100vh; border-radius:0; max-height:100vh; }
      #local-video { width:110px; height:80px; right:8px; top:8px; }
    }
  </style>
</head>
<body>
  <div id="app-container">

    <!-- AUTH VIEW -->
    <div id="auth-view" class="view active">
      <h1>CallingApp</h1>

      <div class="auth-forms">
        <form id="login-form">
          <input type="email" id="login-email" placeholder="Email" required />
          <input type="password" id="login-password" placeholder="Password" required />
          <button type="submit">Log in</button>
          <div id="login-error" class="error hidden"></div>
          <div style="margin-top:8px;">
            <span class="link-like" id="to-signup">Create account</span>
          </div>
        </form>

        <form id="signup-form" class="hidden" style="margin-top:12px;">
          <input type="text" id="signup-username" placeholder="Choose a username (unique)" required />
          <input type="email" id="signup-email" placeholder="Email" required />
          <input type="password" id="signup-password" placeholder="Password" required />
          <button type="submit">Sign up</button>
          <div id="signup-error" class="error hidden"></div>
          <div style="margin-top:8px;">
            <span class="link-like" id="to-login">Already have account? Login</span>
          </div>
        </form>
      </div>
    </div>

    <!-- MAIN VIEW -->
    <div id="main-view" class="view">
      <header class="main-header">
        <div class="header-top">
          <div class="title">CallingApp</div>
          <div class="icon-group">
            <button id="add-friend-btn" class="icon-btn" title="Add Friend">
              <!-- Plus user icon -->
              <svg viewBox="0 0 24 24"><path d="M15 14c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9 2c0 2.21 1.79 4 4 4h1v-2H10c-1.1 0-2-.9-2-2v-1H6v1zM19 11v2h2V13h-2zm-10 1H7v-2h2v2z"/></svg>
            </button>
            <button id="menu-btn" class="icon-btn" title="Profile & Settings">
              <!-- Menu icon -->
              <svg viewBox="0 0 24 24"><path d="M12 7a2 2 0 110-4 2 2 0 010 4zm0 2a2 2 0 110 4 2 2 0 010-4zm0 6a2 2 0 110 4 2 2 0 010-4z"/></svg>
            </button>
          </div>
        </div>

        <nav class="header-nav" role="tablist">
          <div id="nav-home" class="nav-tab active" data-panel="home-content">Chats <span class="badge" id="badge-home" style="display:none;">0</span></div>
          <div id="nav-notifications" class="nav-tab" data-panel="notifications-content">Updates <span class="badge" id="badge-updates" style="display:none;">0</span></div>
          <div id="nav-calls" class="nav-tab" data-panel="calls-content">Calls <span class="badge" id="badge-calls" style="display:none;">0</span></div>
        </nav>
      </header>

      <main id="main-content">
        <!-- HOME / CHATS -->
        <section id="home-content" class="content-panel active">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <strong>Chats</strong>
            <small id="my-username-display" style="color:var(--wa-text-secondary)"></small>
          </div>
          <div id="contacts-list" style="display:flex;flex-direction:column;gap:10px;"></div>
        </section>

        <!-- UPDATES -->
        <section id="notifications-content" class="content-panel">
          <strong>Updates</strong>
          <div id="requests-list" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>
        </section>

        <!-- CALL LOGS -->
        <section id="calls-content" class="content-panel">
          <strong>Calls</strong>
          <div id="call-logs" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>
        </section>
      </main>
    </div>

    <!-- CHAT VIEW -->
    <div id="chat-view" class="view">
      <header class="chat-header">
        <button class="back-btn" id="chat-back-btn" title="Back">
          <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </button>
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="contact-title" id="chat-contact-title">Contact</div>
        </div>
        <div style="margin-left:auto; display:flex; gap:6px;">
          <button id="voice-call-btn" class="icon-btn" title="Voice Call">
            <svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.053 15.053 0 006.59 6.59l2.2-2.2a1 1 0 011.11-.21c1.22.49 2.54.76 3.9.76a1 1 0 011 1v3.5a1 1 0 01-1 1C10.07 21.5 2.5 13.93 2.5 4a1 1 0 011-1H7a1 1 0 011 1c0 1.36.26 2.68.76 3.9.16.4.05.86-.21 1.11l-2.43 2.78z"/></svg>
          </button>
          <button id="video-call-btn" class="icon-btn" title="Video Call">
            <svg viewBox="0 0 24 24"><path d="M17 10.5V6c0-1.1-.9-2-2-2H3C1.9 4 1 4.9 1 6v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4.5l4 4v-11l-4 4z"/></svg>
          </button>
          <button id="chat-more-btn" class="icon-btn" title="More">
            <svg viewBox="0 0 24 24"><path d="M12 8a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z"/></svg>
          </button>
        </div>
      </header>

      <div id="chat-messages"></div>

      <div id="chat-input-container">
        <input id="chat-input" placeholder="Type a message" />
        <button id="chat-send-btn">Send</button>
      </div>
    </div>

    <!-- CALL VIEWS -->
    <div id="video-call-view" class="call-view">
      <video id="remote-video" autoplay playsinline></video>
      <video id="local-video" autoplay muted playsinline></video>
      <div class="call-overlay">
        <div class="caller-info">
          <div id="call-label">Video Call</div>
          <div id="call-peer-name" style="font-weight:600;"></div>
        </div>
        <div class="call-controls">
          <button id="end-call-btn" class="call-btn call-end">End</button>
        </div>
      </div>
    </div>

    <div id="voice-call-view" class="call-view">
      <audio id="remote-audio" autoplay></audio>
      <div class="call-overlay">
        <div class="caller-info">
          <div id="voice-call-label">Voice Call</div>
          <div id="voice-call-peer-name" style="font-weight:600;"></div>
        </div>
        <div class="call-controls">
          <button id="end-voice-btn" class="call-btn call-end">End</button>
        </div>
      </div>
    </div>

    <!-- MODALS -->
    <div id="profile-setup-modal" class="modal">
      <div class="modal-content">
        <h3>Complete your profile</h3>
        <input id="profile-name" placeholder="Full name" />
        <input id="profile-username" placeholder="Username (can't change later)" />
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
          <button id="save-profile-btn" class="small-btn" style="background:var(--wa-accent-blue); color:#fff;">Save</button>
        </div>
      </div>
    </div>

    <div id="add-friend-modal" class="modal">
      <div class="modal-content">
        <h3>Add Friend by username</h3>
        <input id="add-friend-username" placeholder="Friend's username" />
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
          <button id="send-request-btn" class="small-btn" style="background:var(--wa-button-color); color:#fff;">Send Request</button>
          <button id="close-add-friend" class="small-btn">Close</button>
        </div>
        <div id="add-friend-msg" style="margin-top:8px;color:var(--wa-text-secondary)"></div>
      </div>
    </div>

    <div id="profile-view-modal" class="modal">
      <div class="modal-content">
        <h3>Profile</h3>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div><strong id="profile-name-display"></strong></div>
          <div>Username: <span id="profile-username-display"></span></div>
          <div>Blocked users:</div>
          <div id="blocked-list" style="display:flex;flex-direction:column;gap:6px;"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
            <button id="logout-btn" class="small-btn" style="background:#e53935;color:#fff;">Logout</button>
            <button id="close-profile-modal" class="small-btn">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div id="incoming-call-modal" class="modal">
      <div class="modal-content">
        <h3>Incoming call</h3>
        <div id="incoming-from" style="font-weight:600;margin-bottom:12px;"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;">
          <button id="accept-call-btn" class="small-btn call-accept">Accept</button>
          <button id="reject-call-btn" class="small-btn call-end">Reject</button>
        </div>
      </div>
    </div>

    <!-- Ringtone -->
    <audio id="ringtone" loop>
      <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
    </audio>

  </div>

  <!-- Firebase v8.10.1 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    /********************************************************************
     * Initialization & Global State
     ********************************************************************/
    // Firebase config (placeholder â€” replace with real values)



  const firebaseConfig = {
  apiKey: "AIzaSyDqpCFgFGUmw2e5fR1l-BUSZdoECMZzGY4",
  authDomain: "chattrio-fc1d0.firebaseapp.com",
  databaseURL: "https://chattrio-fc1d0-default-rtdb.firebaseio.com",
  projectId: "chattrio-fc1d0",
  storageBucket: "chattrio-fc1d0.firebasestorage.app",
  messagingSenderId: "124858239322",
  appId: "1:124858239322:web:d97ae0b4d44f3b7c1e8b63"
};




    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    // Global state
    let currentUser = null;
    let currentProfile = null; // profile data from DB
    let currentChatPartner = null; // { uid, username, name }
    let currentChatId = null;
    let peerConnection = null;
    let localStream = null;
    let remoteStream = null;
    let outgoingCallRef = null;
    let incomingCallRef = null;
    let currentCallId = null;
    let rtcIceCandidatesListener = null;

    /********************************************************************
     * UI Helpers: showView, showModal, showPanel
     ********************************************************************/
    function showView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
    }

    function showModal(id, show = true) {
      const el = document.getElementById(id);
      if (!el) return;
      if (show) el.classList.add('active'); else el.classList.remove('active');
    }

    function showPanel(panelId) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content-panel').forEach(c => c.classList.remove('active'));
      const tab = [...document.querySelectorAll('.nav-tab')].find(t => t.dataset.panel === panelId);
      if (tab) tab.classList.add('active');
      document.getElementById(panelId).classList.add('active');
    }

    /********************************************************************
     * Utility functions
     ********************************************************************/
    function uidPair(a,b) {
      return [a,b].sort().join('_');
    }

    function showError(containerId, msg) {
      const el = document.getElementById(containerId);
      if (!el) return;
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(()=> el.classList.add('hidden'), 5000);
    }

    function setBadge(id, count) {
      const el = document.getElementById(id);
      if (!el) return;
      if (count && count > 0) { el.style.display='inline-flex'; el.textContent = count; }
      else el.style.display='none';
    }

    /********************************************************************
     * Auth: onAuthStateChanged, login, signup, logout
     ********************************************************************/
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        // load profile
        const profileSnap = await db.ref('users/' + user.uid).once('value');
        const profile = profileSnap.val();
        currentProfile = profile || null;

        if (!profile || !profile.username) {
          // open profile setup
          showModal('profile-setup-modal', true);
          showView('main-view'); // keep main view but modal over it
        } else {
          initializeAppForUser();
        }
      } else {
        // logged out
        currentProfile = null;
        currentChatPartner = null;
        showView('auth-view');
      }
    });

    // Login form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        // Show user-friendly messages for common auth errors
        if (err && err.code === 'auth/wrong-password') {
          showError('login-error', 'Password is not right');
        } else if (err && err.code === 'auth/user-not-found') {
          showError('login-error', 'User not found');
        } else if (err && err.code === 'auth/invalid-email') {
          showError('login-error', 'Invalid email address');
        } else {
          showError('login-error', err.message || 'Login failed');
        }
      }
    });

    // Signup form
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('signup-username').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;

      if (!username) { showError('signup-error', 'Choose a username'); return; }

      try {
        // ensure username uniqueness
        const userByName = await db.ref('usernames/' + username).once('value');
        if (userByName.exists()) {
          showError('signup-error', 'Username already taken');
          return;
        }

        const cred = await auth.createUserWithEmailAndPassword(email, password);
        const uid = cred.user.uid;

        // Save a basic profile - full profile will be completed in profile setup modal
        const profileObj = {
          uid,
          username,
          email,
          name: null,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          blocked: {}
        };
        await db.ref('users/' + uid).set(profileObj);
        // map username to uid for quick lookup
        await db.ref('usernames/' + username).set(uid);

        // update currentProfile and show profile setup
        currentProfile = profileObj;
        showModal('profile-setup-modal', true);
        showView('main-view');
      } catch (err) {
        showError('signup-error', err.message || 'Signup failed');
      }
    });

    // toggles
    document.getElementById('to-signup').addEventListener('click', () => {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('signup-form').classList.remove('hidden');
    });
    document.getElementById('to-login').addEventListener('click', () => {
      document.getElementById('signup-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await auth.signOut();
      showModal('profile-view-modal', false);
      showView('auth-view');
    });

    /********************************************************************
     * Profile management
     ********************************************************************/

    document.getElementById('save-profile-btn').addEventListener('click', async () => {
      const name = document.getElementById('profile-name').value.trim();
      const username = document.getElementById('profile-username').value.trim();

      if (!currentUser) return;
      if (!username) { alert('Username required'); return; }

      // ensure username uniqueness (if not already assigned)
      const existing = await db.ref('usernames/' + username).once('value');
      if (existing.exists() && existing.val() !== currentUser.uid) {
        alert('Username is taken');
        return;
      }

      // set profile
      const profile = {
        uid: currentUser.uid,
        name: name || username,
        username,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        blocked: {}
      };
      await db.ref('users/' + currentUser.uid).update(profile);
      await db.ref('usernames/' + username).set(currentUser.uid);
      currentProfile = profile;
      showModal('profile-setup-modal', false);
      initializeAppForUser();
    });

    // Profile modal open/close
    document.getElementById('menu-btn').addEventListener('click', () => {
      if (!currentProfile) return;
      document.getElementById('profile-name-display').textContent = currentProfile.name || '';
      document.getElementById('profile-username-display').textContent = currentProfile.username || '';
      populateBlockedList();
      showModal('profile-view-modal', true);
    });
    document.getElementById('close-profile-modal').addEventListener('click', () => showModal('profile-view-modal', false));

    async function populateBlockedList() {
      const blockedDiv = document.getElementById('blocked-list');
      blockedDiv.innerHTML = '';
      if (!currentProfile || !currentProfile.blocked) return;
      const blocked = currentProfile.blocked;
      for (const uid in blocked) {
        const username = blocked[uid];
        const row = document.createElement('div');
        row.style.display='flex';
        row.style.justifyContent='space-between';
        row.style.alignItems='center';
        row.textContent = username;
        const btn = document.createElement('button');
        btn.textContent = 'Unblock';
        btn.className='small-btn';
        btn.addEventListener('click', async () => {
          await db.ref('users/' + currentUser.uid + '/blocked/' + uid).remove();
          currentProfile.blocked = currentProfile.blocked || {};
          delete currentProfile.blocked[uid];
          populateBlockedList();
        });
        row.appendChild(btn);
        blockedDiv.appendChild(row);
      }
    }

    /********************************************************************
     * Initialize app for user: listeners for contacts, requests, unread
     ********************************************************************/
    function initializeAppForUser() {
      if (!currentUser) return;
      showView('main-view');
      document.getElementById('my-username-display').textContent = currentProfile.username ? ('@' + currentProfile.username) : '';
      listenForContacts();
      listenForRequests();
      listenForUnreadCounts();
      listenForIncomingCalls();
    }

    /********************************************************************
     * Friend & Contact System (username-based)
     ********************************************************************/
    document.getElementById('add-friend-btn').addEventListener('click', () => {
      document.getElementById('add-friend-username').value = '';
      document.getElementById('add-friend-msg').textContent = '';
      showModal('add-friend-modal', true);
    });
    document.getElementById('close-add-friend').addEventListener('click', () => showModal('add-friend-modal', false));

    document.getElementById('send-request-btn').addEventListener('click', async () => {
      const targetUsername = document.getElementById('add-friend-username').value.trim();
      if (!targetUsername) { document.getElementById('add-friend-msg').textContent = 'Enter a username'; return; }

      const snap = await db.ref('usernames/' + targetUsername).once('value');
      if (!snap.exists()) { document.getElementById('add-friend-msg').textContent = 'User not found'; return; }
      const targetUid = snap.val();

      if (targetUid === currentUser.uid) { document.getElementById('add-friend-msg').textContent = 'Cannot add yourself'; return; }

      // push request under requests/{targetUid}/{requestId}
      const reqRef = db.ref('requests/' + targetUid).push();
      await reqRef.set({
        fromUid: currentUser.uid,
        fromUsername: currentProfile.username || null,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      document.getElementById('add-friend-msg').textContent = 'Request sent';
      setTimeout(()=> showModal('add-friend-modal', false), 900);
    });

    async function listenForRequests() {
      if (!currentUser) return;
      const reqRef = db.ref('requests/' + currentUser.uid);
      reqRef.off();
      reqRef.on('value', snap => {
        const container = document.getElementById('requests-list');
        container.innerHTML = '';
        const data = snap.val() || {};
        const keys = Object.keys(data);
        setBadge('badge-updates', keys.length);
        for (const k of keys.reverse()) {
          const r = data[k];
          const item = document.createElement('div');
          item.className = 'list-item';
          item.innerHTML = `<div class="avatar">${r.fromUsername ? r.fromUsername.charAt(0).toUpperCase() : 'U'}</div>
            <div class="details"><strong>${r.fromUsername || 'Unknown'}</strong><div class="meta">Friend request</div></div>`;
          const actions = document.createElement('div');
          actions.style.display='flex'; actions.style.gap='6px';
          const accept = document.createElement('button'); accept.className = 'small-btn'; accept.textContent='Accept';
          accept.addEventListener('click', async () => {
            await acceptRequest(k, r.fromUid, r.fromUsername);
          });
          const reject = document.createElement('button'); reject.className='small-btn'; reject.textContent='Reject';
          reject.addEventListener('click', async () => {
            await db.ref('requests/' + currentUser.uid + '/' + k).remove();
          });
          actions.appendChild(accept); actions.appendChild(reject);
          item.appendChild(actions);
          container.appendChild(item);
        }
      });
    }

    async function acceptRequest(requestId, fromUid, fromUsername) {
      // create mutual contact entries
      const updates = {};
      updates['contacts/' + currentUser.uid + '/' + fromUid] = { uid: fromUid, username: fromUsername, createdAt: firebase.database.ServerValue.TIMESTAMP };
      updates['contacts/' + fromUid + '/' + currentUser.uid] = { uid: currentUser.uid, username: currentProfile.username, createdAt: firebase.database.ServerValue.TIMESTAMP };
      updates['requests/' + currentUser.uid + '/' + requestId] = null; // remove
      await db.ref().update(updates);
    }

    function listenForContacts() {
      if (!currentUser) return;
      const cRef = db.ref('contacts/' + currentUser.uid);
      cRef.off();
      cRef.on('value', snap => {
        const data = snap.val() || {};
        renderContactsList(data);
        setBadge('badge-home', Object.keys(data).length);
      });
    }

    function renderContactsList(data) {
      const container = document.getElementById('contacts-list');
      container.innerHTML = '';
      const uids = Object.keys(data).sort((a,b)=> (data[a].username||'').localeCompare(data[b].username||''));
      for (const uid of uids) {
        const c = data[uid];
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `<div class="avatar">${(c.username||'U').charAt(0).toUpperCase()}</div>
          <div class="details"><strong>${c.username}</strong><div class="meta">Tap to chat</div></div>`;
        item.addEventListener('click', () => openChatWith(c));
        container.appendChild(item);
      }
    }

    /********************************************************************
     * Messaging: open chat, listen messages, send messages, unread
     ********************************************************************/
    async function openChatWith(contact) {
      if (!currentUser) return;
      currentChatPartner = contact;
      currentChatId = uidPair(currentUser.uid, contact.uid);
      document.getElementById('chat-contact-title').textContent = contact.username;
      showView('chat-view');

      // mark unread as read
      await db.ref('unreadCounts/' + currentUser.uid + '/' + currentChatId).remove();

      // listen messages
      listenForMessages(currentChatId);
    }

    function listenForMessages(chatId) {
      const ref = db.ref('messages/' + chatId);
      ref.off();
      ref.on('value', snap => {
        const messages = snap.val() || {};
        renderMessages(messages);
      });
    }

    function renderMessages(messages) {
      const container = document.getElementById('chat-messages');
      container.innerHTML = '';
      const keys = Object.keys(messages || {});
      for (const k of keys) {
        const m = messages[k];
        const div = document.createElement('div');
        div.className = 'message-bubble ' + (m.from === currentUser.uid ? 'message-sent' : 'message-received');
        div.textContent = m.text;
        container.appendChild(div);
      }
      container.scrollTop = container.scrollHeight;
    }

    document.getElementById('chat-send-btn').addEventListener('click', async () => {
      const textEl = document.getElementById('chat-input');
      const text = textEl.value.trim();
      if (!text || !currentChatPartner) return;
      const chatId = uidPair(currentUser.uid, currentChatPartner.uid);
      const msgRef = db.ref('messages/' + chatId).push();
      const msgObj = { from: currentUser.uid, to: currentChatPartner.uid, text, ts: firebase.database.ServerValue.TIMESTAMP };
      await msgRef.set(msgObj);
      // increment recipient unread count
      const countRef = db.ref('unreadCounts/' + currentChatPartner.uid + '/' + chatId);
      countRef.transaction(curr => (curr || 0) + 1);
      textEl.value = '';
    });

    // Back to main
    document.getElementById('chat-back-btn').addEventListener('click', () => {
      currentChatPartner = null;
      currentChatId = null;
      showView('main-view');
    });

    // Listen unreadCounts for badges
    function listenForUnreadCounts() {
      if (!currentUser) return;
      const ref = db.ref('unreadCounts/' + currentUser.uid);
      ref.off();
      ref.on('value', snap => {
        const data = snap.val() || {};
        let total = 0;
        for (const k in data) total += (data[k] || 0);
        setBadge('badge-home', total);
      });
    }

    /********************************************************************
     * Calls: WebRTC & Firebase signaling
     *
     * Strategy: calls/{calleeUid}/{callId} stores call object { callerUid, callerName, type, offer, answer }
     * iceCandidates/{callId}/{caller|callee}/{pushId} stores candidate objects
     ********************************************************************/

    // UI for starting calls
    document.getElementById('voice-call-btn').addEventListener('click', () => startCall('voice'));
    document.getElementById('video-call-btn').addEventListener('click', () => startCall('video'));

    async function startCall(type='video') {
      if (!currentChatPartner || !currentUser) return alert('Open a chat with the user you want to call.');
      // create call entry under calls/{calleeUid}
      const callId = db.ref().push().key;
      currentCallId = callId;
      const calleeUid = currentChatPartner.uid;
      const callerUid = currentUser.uid;
      const callerName = currentProfile.username || currentProfile.name || 'Unknown';

      // get media
      try {
        localStream = await navigator.mediaDevices.getUserMedia(type === 'video' ? { video:true, audio:true } : { audio:true });
      } catch (err) {
        alert('Could not access media: ' + err.message);
        return;
      }

      // show local video if video
      if (type === 'video') {
        document.getElementById('local-video').srcObject = localStream;
      } else {
        // voice call; don't show local video element
      }

      peerConnection = new RTCPeerConnection();
      // attach tracks
      localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

      // collect remote stream
      remoteStream = new MediaStream();
      peerConnection.addEventListener('track', event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        if (type === 'video') {
          document.getElementById('remote-video').srcObject = remoteStream;
        } else {
          document.getElementById('remote-audio').srcObject = remoteStream;
        }
      });

      // candidate handling
      const callCandidatesRef = db.ref('iceCandidates/' + callId + '/caller');
      peerConnection.addEventListener('icecandidate', event => {
        if (event.candidate) {
          callCandidatesRef.push(event.candidate.toJSON());
        }
      });

      // create offer
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      // write call
      await db.ref('calls/' + calleeUid + '/' + callId).set({
        callId,
        callerUid,
        callerName,
        type,
        offer
      });

      // play ringtone for caller? skipped

      // listen for answer
      const callRef = db.ref('calls/' + calleeUid + '/' + callId);
      callRef.on('value', async snap => {
        const data = snap.val();
        if (data && data.answer && !peerConnection.currentRemoteDescription) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
      });

      // listen for callee ICE candidates
      db.ref('iceCandidates/' + callId + '/callee').on('child_added', snap => {
        const cand = snap.val();
        if (cand) peerConnection.addIceCandidate(new RTCIceCandidate(cand)).catch(()=>{});
      });

      // open outgoing call UI
      if (type === 'video') {
        document.getElementById('call-peer-name').textContent = currentChatPartner.username;
        showView('video-call-view');
      } else {
        document.getElementById('voice-call-peer-name').textContent = currentChatPartner.username;
        showView('voice-call-view');
      }

      // store outgoingCallRef for cleanup
      outgoingCallRef = callRef;
    }

    // Listen for calls to current user (incoming)
    function listenForIncomingCalls() {
      if (!currentUser) return;
      const r = db.ref('calls/' + currentUser.uid);
      r.off();
      r.on('child_added', snap => {
        const callData = snap.val();
        if (!callData) return;
        // check blocked list
        const callerUid = callData.callerUid;
        if (currentProfile && currentProfile.blocked && currentProfile.blocked[callerUid]) {
          // ignore incoming from blocked user
          db.ref('calls/' + currentUser.uid + '/' + callData.callId).remove();
          return;
        }
        // show incoming call modal
        incomingCallRef = snap.ref;
        currentCallId = callData.callId;
        document.getElementById('incoming-from').textContent = callData.callerName + ' is calling (' + callData.type + ')';
        showModal('incoming-call-modal', true);

        // prepare ringtone
        const rtone = document.getElementById('ringtone');
        try { rtone.play().catch(()=>{}); } catch(e){}
      });
    }

    // Accept call
    document.getElementById('accept-call-btn').addEventListener('click', async () => {
      if (!incomingCallRef) return;
      const callObj = (await incomingCallRef.once('value')).val();
      if (!callObj) { showModal('incoming-call-modal', false); return; }

      const { callId, callerUid, callerName, type, offer } = callObj;
      currentCallId = callId;

      // check blocked
      if (currentProfile && currentProfile.blocked && currentProfile.blocked[callerUid]) {
        incomingCallRef.remove();
        showModal('incoming-call-modal', false);
        return;
      }

      // stop ringing
      try { document.getElementById('ringtone').pause(); document.getElementById('ringtone').currentTime = 0; } catch(e){}

      // get media
      try {
        localStream = await navigator.mediaDevices.getUserMedia(type === 'video' ? { video:true, audio:true } : { audio:true });
      } catch (err) {
        alert('Could not access media: ' + err.message);
        incomingCallRef.remove();
        showModal('incoming-call-modal', false);
        return;
      }

      peerConnection = new RTCPeerConnection();
      localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

      // handle remote
      remoteStream = new MediaStream();
      peerConnection.addEventListener('track', event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        if (type === 'video') {
          document.getElementById('remote-video').srcObject = remoteStream;
          document.getElementById('local-video').srcObject = localStream;
          showView('video-call-view');
        } else {
          document.getElementById('remote-audio').srcObject = remoteStream;
          showView('voice-call-view');
        }
      });

      // accept offer
      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

      // ICE -> push to db under iceCandidates/{callId}/callee
      const candidatesRef = db.ref('iceCandidates/' + callId + '/callee');
      peerConnection.addEventListener('icecandidate', event => {
        if (event.candidate) {
          candidatesRef.push(event.candidate.toJSON());
        }
      });

      // create answer
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      // write answer back to calls/{calleeUid}/{callId}
      await incomingCallRef.update({ answer });

      // listen for caller's ICE
      db.ref('iceCandidates/' + callId + '/caller').on('child_added', snap => {
        const c = snap.val();
        if (c) peerConnection.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{});
      });

      showModal('incoming-call-modal', false);
    });

    // Reject call
    document.getElementById('reject-call-btn').addEventListener('click', async () => {
      if (!incomingCallRef) { showModal('incoming-call-modal', false); return; }
      await incomingCallRef.remove();
      showModal('incoming-call-modal', false);
      try { document.getElementById('ringtone').pause(); document.getElementById('ringtone').currentTime = 0; } catch(e){}
    });

    // End call (both views)
    async function endCallCleanup() {
      try {
        if (peerConnection) { peerConnection.close(); peerConnection = null; }
        if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
        if (remoteStream) { remoteStream = null; }
        // remove signaling entries
        if (currentCallId) {
          // remove any iceCandidates entries and calls entries referencing this call for both sides
          await db.ref('iceCandidates/' + currentCallId).remove();
          // remove calls nodes where this callId is present for the callee
          // We attempt to remove both possible locations: calls/{calleeUid}/{callId} and calls/{callerUid}/{callId}
          // WARNING: this is a best-effort cleanup.
          await db.ref('calls').once('value', snap => {
            const callsObj = snap.val() || {};
            for (const uid in callsObj) {
              if (callsObj[uid] && callsObj[uid][currentCallId]) {
                db.ref('calls/' + uid + '/' + currentCallId).remove().catch(()=>{});
              }
            }
          });
        }
      } catch (e) {
        console.warn('endCall cleanup error', e);
      } finally {
        currentCallId = null;
        outgoingCallRef = null;
        incomingCallRef = null;
        showView('main-view');
        // refresh the page after call ends
        setTimeout(() => {
          try { window.location.reload(); } catch(e) {}
        }, 400);
      }
    }

    document.getElementById('end-call-btn').addEventListener('click', endCallCleanup);
    document.getElementById('end-voice-btn').addEventListener('click', endCallCleanup);

    /********************************************************************
     * Blocking: add to blocked list before showing contacts/processing requests
     ********************************************************************/
    // Block user example function (hook to UI as needed)
    async function blockUser(uidToBlock, usernameToBlock) {
      if (!currentUser) return;
      await db.ref('users/' + currentUser.uid + '/blocked/' + uidToBlock).set(usernameToBlock || true);
      // refresh profile
      const snap = await db.ref('users/' + currentUser.uid).once('value');
      currentProfile = snap.val();
    }

    /********************************************************************
     * Attach UI nav handlers
     ********************************************************************/
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const panel = tab.dataset.panel;
        document.querySelectorAll('.content-panel').forEach(p=>p.classList.remove('active'));
        document.getElementById(panel).classList.add('active');
      });
    });

    /********************************************************************
     * Ensure all event listeners attached to HTML elements defined earlier
     ********************************************************************/

    // Profile modal close when clicking outside (simple)
    document.querySelectorAll('.modal').forEach(mod => {
      mod.addEventListener('click', (e) => {
        if (e.target === mod) mod.classList.remove('active');
      });
    });

    /********************************************************************
     * Basic cleanup when unloading
     ********************************************************************/
    window.addEventListener('beforeunload', () => {
      try { if (peerConnection) peerConnection.close(); } catch(e){}
    });

    /********************************************************************
     * Extra: listen for profile updates to reflect blocked list / username
     ********************************************************************/
    if (auth.currentUser) {
      db.ref('users/' + auth.currentUser.uid).on('value', snap => {
        const p = snap.val();
        if (p) {
          currentProfile = p;
          if (document.getElementById('profile-username-display')) {
            document.getElementById('profile-username-display').textContent = p.username || '';
          }
        }
      });
    }

    /********************************************************************
     * Final: attach basic call logs / lists rendering (optional)
     ********************************************************************/
    // Very simple call logs listener
    function listenForCallLogs() {
      if (!currentUser) return;
      const ref = db.ref('callLogs/' + currentUser.uid).limitToLast(50);
      ref.off();
      ref.on('value', snap => {
        const data = snap.val() || {};
        const container = document.getElementById('call-logs');
        container.innerHTML = '';
        const keys = Object.keys(data);
        for (const k of keys.reverse()) {
          const c = data[k];
          const item = document.createElement('div');
          item.className = 'list-item';
          item.innerHTML = `<div class="avatar">${(c.peerUsername||'U').charAt(0).toUpperCase()}</div>
            <div class="details"><strong>${c.peerUsername || 'Unknown'}</strong><div class="meta">${c.type || 'call'} â€¢ ${new Date(c.ts||0).toLocaleString()}</div></div>`;
          container.appendChild(item);
        }
      });
    }

    // Attach initial listeners if user is already logged in at script load
    if (auth.currentUser) {
      currentUser = auth.currentUser;
      db.ref('users/' + currentUser.uid).once('value').then(snap => { currentProfile = snap.val(); initializeAppForUser(); });
    }
  </script>
</body>
</html>
